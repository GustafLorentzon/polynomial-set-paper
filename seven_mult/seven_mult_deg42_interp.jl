# Computes the degree 42 polynomial with five multiplications
#
# The output is for exp(alpha*X) is Ha,Hb,c

setprecision(128)
using HomotopyContinuation, GraphMatFun, LinearAlgebra, Random
include("../common/degopt_tools.jl")
include("../common/graph_syst.jl")
include("../common/tikhonov.jl")

function setup_system(T,g0,a,poly_order)
    g=Compgraph(T,g0);
    pw=0:poly_order
    dervec= a.^pw;
    dervec=convert.(T,dervec);
    sys=GraphDervecSystem(g,dervec,1 ./dervec,cref);
    return sys
end


m=7; deg=42;

special_val=3.333;
#(Ha,c,_)=build_normalized_degopt(m;reduction=[[zeros(m-2);0;0;0;0],[zeros(m-5);1;1;1;1;1]]);
(Ha,Hb,c)=normalized_degopt(m;reduction=[[zeros(m-2);0;0;0;0],[zeros(m-5);1;1;1;1;1]],special_val=special_val)
Ha[2,2]=1.00;
Ha[3,3]=0.0;
Ha[4,3]=1.0;
Ha[2,3]=special_val;
Ha[5,3]=0;
pretty_print(Degopt(Ha,Hb,c))

#Ha[:,2] .= special_val; Ha[1,2]=1;
#Ha[3,2:3] .= special_val;
#Hb[:,1] .= special_val;

#Ha[3,3]=1.0;

(g0,cref)=graph_degopt(Degopt(Ha,Hb,c));


cref=cref[findall(get_coeffs(g0,cref) .== special_val)];
#deleteat!(cref,25);
#deleteat!(cref,21);
##deleteat!(cref,16);
#deleteat!(cref,12);
#
a=big(16.0);



T=ComplexF64
sys=setup_system(T,g0,a,deg)

sys_target=deepcopy(sys);

sys1=deepcopy(sys_target);



#
x0=get_coeffs(sys.graph,cref);
Random.seed!(0);
#x0=rand(size(x0,1)) +1im*rand(size(x0,1));
#x0[2:2:end] .=0;
for j=1:3
    global x0, J
    x0=rand(size(x0,1));
    J=jac(sys_target,x0)
    @show Float64.(cond(J))
end

#
#x0=rand(size(x0,1)) +1im*rand(size(x0,1));
Random.seed!(0);
#x0=randn(size(x0,1)) .+ 0*1im;
x0=rand(size(x0,1)) + rand(size(x0,1))*1im;

x=x0;
for j=1:100
    global x;
    Fv0=sys_target(x)
    J=jac(sys_target,x);
    # Tikhonov regularized Gauss-Newton
    d=tikhonov_step(J, Fv0, 1e-3)
    if (j<5)
        x=x-1e-2*d;
    else
        x=x-1e-1*d;
    end
    @show norm(x), norm(Fv0)
end

@show x

#asd
#
#x= Complex{BigFloat}[0.5454537955754522775384246761074887636704 + 0.4527953914364771166264288112958719064242im, 0.7415798891006220795708058898828629606495 - 0.3048590026822235989564748588091206471664im, -0.3444514710036566112990547988166998004642 - 0.7247638966118464110373090817703150764996im, -2.755310082704898830252402011609964774098 + 4.142014831768766446758525043190602658083im, 0.2730484533774193352848215847922087927408 - 1.033342087064214204746085927330306213806im, 0.144811871010957160926446781451058263438 + 0.5183170111805102218343484541388654705114im, 0.4806427405115366245836174139463623394819 + 0.9548109485333866304663963470691930011854im, -0.5538757250917078415187487994998616622972 + 1.731763339101438276752786082121705814521im, 5.54811811937954339370706378792727400979 - 1.729500271477100488828700589214469017124im, 6.486839012847070050347166087231896988649 + 2.494985555593606359165414386474766817731im, 3.178749776641893297147678092963644301118 - 1.583186844431247794315884050057653540155im, 12.16690187993967851633950481468661072089 - 2.777468849831253848767448754059606952012im, 3.309385378201643437334620010773512183489 - 3.167027103978493621894148777832515131398im, -0.9041189515761571009931927733958360647952 + 0.1841347344007518216637319777037026018283im, -0.06865186278391351900170577005686899341887 - 0.9525482626367996058464409653821770390495im, 50.74063467069386355205371853532360704512 - 39.22483196105931875632719388837086432527im, 98.09654685666698312270528593182154615508 + 34.28358578791880037483287192059117848643im, 65.30909976102669152846758697941552840903 - 63.69116385796595021908208627280817677653im, 4.490304566999815615636698743305034559893 - 20.5477906120796752575903263893316381558im, 88.82676776008873442521602111124064348417 + 28.62888952458016026982644373555532631949im, -21.75619677439217072429537085949105301538 + 15.08283855680295310526335875822547199068im, 20.15592315127026232748080524616492083546 + 27.06182393943607116183538214483704391634im, -0.2273303937353312030141945489703743188444 + 14.29858463361963176215946435615690634135im, 9.578229117148892665524509759663994660936 - 18.62557028907007004439203969277659105139im, -0.8602444486925681449243663197687952354903 - 0.3582013039239204171908211454841838838099im, 0.7352258072719354415688041410168744129911 - 0.08624673603962032077010264706227684053331im, 7.148491900817279260022632373196529808155 - 0.4660663603456035067852625637883855076099im, 33.23334621968411115149197320068633443476 + 26.81917998166562048636185467216077371586im, 21.22964921894227008962669609588838671677 + 84.03394149726052621067304754329392556239im, 6.783351978440773656410327596569333961249 - 59.70817357295418114311026995293308899899im, -11.97172216498388713702621851306404914343 - 7.564826487850269566553731453840373789247im, 30.9430541213370974069607246391785779821 + 31.77371462752788443640613427206735656521im, 19.86873216750803825758664020261867520323 - 70.21151863271152045562135034756168404322im, -8.682217766582847781451944303324447582273 + 1.687350011715712373738862063132201015568im, 0.9999753298244399728970981839616342403402 + 3.888896049549798486840894650464986354563e-09im, 15.99938218771621810369354269350917368274 + 3.899525535450833058460158051234224947632e-09im, -2.653062856686380444103211485420440533878 - 1.047896678456812305410639619398235277811im, -2.773935294647423204573182453684469266018 + 0.01281927943729564263258491884738227456305im, 1.23739325118644019577622214559547069977 - 0.4276660820581169688557937868637866580545im, 12.21036762619241863041038499883182448503 + 5.655135604375814610801136039407583931619im, -8.101895076966589145835174044385309519196 + 1.614403843295057622534492460007656499232im, -3.085776925620097104833821828239841275559 + 5.979285363367799929711105248949129780409im, 0.2643300703339629184932903267455340643237 + 0.0003482148802198513389564925805912802481784im]
#
#
#x=[  0.6125929598581954 + 0.4285686845412627im
#   0.7062578648781196 - 0.46987375221493494im
# -0.45204229656724804 - 0.685985995952618im
#  -2.7047742762716984 + 4.512863297890433im
#  -0.1801398493004186 - 1.0705561614706893im
#  0.11427570629958135 + 0.9644912391853601im
#    0.625514446934514 + 1.0930322381175428im
#   0.7746067902089547 - 0.3211305175636129im
#    7.655906330628268 + 0.47946753165096545im
#    7.417916404343577 + 3.323213390095044im
#   3.2990555669276866 - 1.1732882253746573im
#   11.931869263622676 - 3.0674944871205883im
#   3.4991791569504436 - 3.173671711271186im
#  -0.7476916768325479 + 0.18993880889459788im
#   5.7595513836224415 + 76.03576169217057im
#    75.30254649912538 - 11.612376890901887im
#   158.53229138325207 + 8.749392751143901im
#   63.543866155374246 - 75.51690121364992im
#    4.086684855618261 - 20.286336636023876im
#    92.09749925747433 + 25.054580610228967im
#   -9.772456633259699 + 16.265637263236457im
#    18.46063390884334 + 27.160984473628215im
# -0.28336698189754483 + 13.693325985817168im
#  -2017.4114492065014 + 609.586260948291im
#    1247.397083524518 - 8098.495954077009im
#    4842.167831841449 - 388.97832684099365im
#    2172.828685925762 - 4916.753065242617im
#  -132.06474128183808 - 340.5328678166416im
#    41.91855148317239 + 55.57929187496475im
#   14.721213278493382 - 57.97642587843027im
#   -64.97712866261948 - 11.874257281978181im
#    34.26277236336005 + 16.027303747949972im
#     8.24691820691647 - 77.98266862330495im
#   -9.751906557505873 + 1.745135419480746im
#   0.9999765880033935 + 3.690562351022759e-9im
#    15.99941369614269 + 3.7006497331428403e-9im
#    62679.08675466305 + 116049.77901487274im
#  -38454.219338246374 - 6616.082293945359im
#   -21461.62704697482 + 95697.65220920861im
#   16458.938893360566 - 2614.669670187739im
#   -790.1154035456194 - 370.8392886958382im
#   -9.569161653686953 + 3.6294008071180572im
#  0.26443022058457444 + 0.0003304559213286305im]

#x= [0.38521031106337095 + 0.31147048642525693im
#  0.6609155454943095 + 1.519067560642227im
#  1.5137252172205211 + 2.1379491731687854im
# -3.0440081218228072 - 0.39972679163269353im
# -3.9167112086594287 + 2.569855215350516im
#   4.004595212276199 + 0.6776977749852754im
#  1.6675175721984619 + 2.031867586535737im
#  1.4567237776312734 - 0.13141768421157765im
#  -2.539493767736933 + 7.334852005374981im
#  13.716267414876157 + 1.2702043082024026im
#  0.8618878385423966 + 1.0422558235222659im
#  2.6253690079270955 + 2.0119188538379986im
#   6.732375242902552 + 5.172284561840085im
#  1.8012813570806898 + 1.1546945046099952im
#  -26.70546991095408 + 13.063361814431074im
#  -65.22176745296093 + 5.452977156920044im
#                     â‹®
#  1.8013892836074903 - 5.723259960497594im
# -32.639575367574906 + 9.597101532011676im
#  -50.22187841288249 + 21.02865963797784im
#  20.329793995057724 + 46.81273631949601im
# -6.0238737904959745 + 11.769256866270474im
#  2.1554551644807023 + 4.826767391285134im
#                 1.0 + 1.1994540279020704e-17im
#  15.999999999999996 + 2.037220000322576e-15im
#  -301047.0434715279 - 18732.94174760123im
#  -356528.2069181712 - 138356.98303549888im
#  -54890.89758042143 - 26725.719546129214im
#  -34489.62226652454 + 218.29452970902875im
#  6626.2469685395145 + 3198.4390421563426im
#  -743.0209569394852 + 222.23510285460208im
#  48.809428219137985 + 54.849775437684144im]
#
x=[  0.3852133248966846 + 0.3114827972058397im
  0.6609111450389938 + 1.51904481213723im
  1.5136945302294003 + 2.137879064219611im
  -3.043918480532617 - 0.3996928041974007im
  -3.915973425320048 + 2.5700013158244635im
   4.004435585357485 + 0.6776034590881349im
  1.6674287697032057 + 2.03176580061328im
  1.4566401994436406 - 0.13145411943100638im
   -2.53787898455943 + 7.335697065207486im
  13.714227143752892 + 1.2693863872046753im
  0.8616991832007365 + 1.042113245612752im
  2.6257727911317232 + 2.011845627618979im
   6.732179993656154 + 5.17252033051975im
  1.8010613529406618 + 1.1545856267240227im
 -26.703535875495017 + 13.065143847970301im
  -65.20740571578474 + 5.457316773870953im
   -83.8085189229674 - 65.60112788918858im
 -6.9019284516659605 - 9.643195525791022im
  -7.333032779703689 - 4.002844438710976im
  0.9143286558490956 + 5.141535671703802im
   0.845118346805877 - 5.51332141543346im
  15.717998230675773 - 0.4388370418808085im
  0.9031936776782601 + 0.8777629284636351im
  14.335190760660463 + 19.877047022304982im
  -77.95415100439378 + 306.8994768846462im
   7.517631092225081 - 319.6042672361717im
   51.83207005575744 + 3.7249351922515106im
   9.844949683665495 - 24.36289923925608im
  1.8009840458876676 - 5.722545877284315im
  -32.63984535905508 + 9.594406436026986im
   -50.2180746093592 + 21.038388075409085im
  20.317219672782382 + 46.804485013457686im
  -6.023449638683052 + 11.768844907107523im
  2.1552629945315016 + 4.827285066528261im
                 1.0 + 1.1972264490967441e-17im
  15.999999999999996 + 2.037678058767858e-15im
  -300934.4321165632 - 18526.380119730275im
 -356515.08402944123 - 138223.79324712226im
  -54872.16023564703 - 26705.40638572201im
  -34486.06319066444 + 229.68834599846895im
   6626.137532535943 + 3194.271345081545im
  -742.7037387378073 + 222.39334621252826im
  48.808279155722374 + 54.834791645507835im]


x=convert.(T,x);
#
x0=x;
#
@show cond(jac(sys_target,x0))


@show cond(jac(sys_target,x0))

sys1.rhs[:]=sys_target.rhs + sys_target(x0) .* sys_target.rhs;
#GraphDervecSystem(g,dervec+sys_target(x0).*dervec, 1 ./dervec,cref)

#ghist=[];
delta_theta=2e-4;
theta =0;
x=x0;
graphhist=[];
for k=1:round(Int,1/delta_theta)

    global x,d, tol, lambda, rad,gx,sys;
    global theta,x, sys,lambda
    theta += delta_theta
    @show theta
    sys=interpolate_graph_sys(sys1,sys_target,theta)
    @show norm(sys(x))

    @show norm(sys1(x))
    @show norm(sys_target(x))


    @show cond(jac(sys_target,x))

    #x=x0+rand(size(x0,1))*1e-2;


    push!(graphhist,sys.graph)


    #lambda=0.1/(8);
    lambda=5e-6
    #lambda=lambda/(8*4*2*2*2*8*8);
    #x=x0;
    d=Inf;
    for j=1:1000

        Fv0=sys(x)
        J=jac(sys,x);


#        d=tikhonov_step(J, Fv0, lambda)
#
#        # Armijo damping
#        s=1;  count=0;
#        while norm(Fv0) < norm(sys(x-s*d))    && count<5  && norm(d*s) > 1
#            s=s/2;
#            count=count+1;
#        end
#        x1=x-s*d;
        x1=zeros(size(x));

        if (j>=0) # Only do Tikhonov in the inital stages

            # Gauss-Newton step

            #d=tikhonov_step(J, Fv0, lambda/2)

            d=(J\Fv0);

            #@show norm(d-db)/norm(db)
            # Armijo damping
            s=1;  count=0;
            while norm(Fv0) < norm(sys(x-s*d))    && count<10
                s=s/8;
                count=count+1;
            end
            x2=x-s*d;
        else
            x2=x1;
        end



        # Determine if it is better to do GN or Tikhonov GN
        ii=argmin([10*norm(sys(x1));norm(sys(x2))])
        if (10*norm(sys(x1))<norm(sys(x2)))
            x=x1;
        else
            x=x2;
        end

        condJ=Float64(cond(J))
        normx=Float64(norm(x))
        normF=Float64(norm(sys(x)))
        if (mod(j,10)==0)
            @show (ii,j,normF,condJ, normx)
        end

        if (normF < 1e-12)
            @show normF
            println("DONE!!!")
            export_compgraph(sys.graph,"/tmp/saved_graph.cgr",descr="theta=$theta");
            break;
        end


    end

end


T2=complex(T)
T2=big(T2)
#sysb=setup_system(T,sys.graph,a,deg)
sysb=GraphDervecSystem(Compgraph(T2,sys_target.graph),convert.(T2,sys_target.rhs), convert.(T2,sys_target.scaling), sys.crefs);
#
#T=BigFloat
#sys2=setup_system(T,sys.graph,a,deg)
x=big.(x);
@show norm(sysb(x))
for j=1:10
    F2=svd(jac(sysb,x));
    x[:]=x-F2\sysb(x);
    @show norm(sysb(x))
end
#
